# Loki v3 Helm Values (최신 차트)
# helm repo add grafana https://grafana.github.io/helm-charts
# helm repo update
# helm install loki grafana/loki -n logging --create-namespace -f loki-values.yaml

# 배포 모드: SingleBinary (로컬/중소규모, filesystem 스토리지 사용)
deploymentMode: SingleBinary

loki:
  # 인증 비활성화 (내부 사용)
  auth_enabled: false

  # 공통 설정
  commonConfig:
    replication_factor: 1

  # 스토리지 설정
  storage:
    type: filesystem

  # 스키마 설정
  schemaConfig:
    configs:
      - from: "2024-01-01"
        store: tsdb
        object_store: filesystem
        schema: v13
        index:
          prefix: index_
          period: 24h

  # 보존 기간 설정
  limits_config:
    retention_period: 168h # 7일
    max_query_length: 168h
    # 수집 제한
    ingestion_rate_mb: 10
    ingestion_burst_size_mb: 20
    per_stream_rate_limit: 5MB
    per_stream_rate_limit_burst: 10MB
    max_entries_limit_per_query: 10000
    max_streams_per_user: 0
    max_global_streams_per_user: 0

  # Compactor 설정 (오래된 로그 자동 삭제)
  compactor:
    retention_enabled: true
    delete_request_store: filesystem
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
    compaction_interval: 10m

# Single Binary 모드 설정 (모든 컴포넌트가 하나의 프로세스에서 실행)
singleBinary:
  replicas: 1  # filesystem 스토리지에서는 1개만 가능 (HA를 위해선 object storage 필요)
  persistence:
    enabled: true
    size: 100Gi  # 1개 replica에 모든 데이터 저장
    storageClass: local-path
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 200m
      memory: 512Mi
  # Compactor를 single binary에 포함
  extraArgs:
    - -target=all,compactor

  # 특정 노드(processor-1)에만 배치
  nodeSelector:
    kubernetes.io/hostname: processor-1

# Write/Read/Backend 컴포넌트 비활성화 (SingleBinary 모드에서는 불필요)
write:
  replicas: 0

read:
  replicas: 0

backend:
  replicas: 0

# Gateway 비활성화 (SingleBinary 직접 접근)
gateway:
  enabled: false

# 모니터링
monitoring:
  selfMonitoring:
    enabled: false
    grafanaAgent:
      installOperator: false
  lokiCanary:
    enabled: false

# 테스트 비활성화
test:
  enabled: false
