---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: network-tuning
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: network-tuning
  template:
    metadata:
      labels:
        app: network-tuning
    spec:
      hostNetwork: true
      hostPID: true
      initContainers:
        - name: sysctl-tuning
          image: busybox:1.35
          command:
            - /bin/sh
            - -c
            - |
              echo "Applying network tuning..."

              # Conntrack
              sysctl -w net.netfilter.nf_conntrack_max=1048576 || true
              sysctl -w net.nf_conntrack_max=1048576 || true

              # Ephemeral ports
              sysctl -w net.ipv4.ip_local_port_range="10000 65535"

              # TIME_WAIT optimization
              sysctl -w net.ipv4.tcp_tw_reuse=1
              sysctl -w net.ipv4.tcp_fin_timeout=30

              # File descriptors
              sysctl -w fs.file-max=2097152

              # TCP tuning
              sysctl -w net.core.somaxconn=32768
              sysctl -w net.ipv4.tcp_max_syn_backlog=8192
              sysctl -w net.core.rmem_max=16777216
              sysctl -w net.core.wmem_max=16777216

              # Conntrack timeout
              sysctl -w net.netfilter.nf_conntrack_tcp_timeout_established=600 || true

              echo "Network tuning applied successfully"

              # 설정 파일 영구 저장 (호스트 재부팅 시에도 유지)
              cat > /host-sysctl/99-network-tuning.conf <<EOF
              net.netfilter.nf_conntrack_max = 1048576
              net.nf_conntrack_max = 1048576
              net.ipv4.ip_local_port_range = 10000 65535
              net.ipv4.tcp_tw_reuse = 1
              net.ipv4.tcp_fin_timeout = 30
              fs.file-max = 2097152
              net.core.somaxconn = 32768
              net.ipv4.tcp_max_syn_backlog = 8192
              net.core.rmem_max = 16777216
              net.core.wmem_max = 16777216
              net.netfilter.nf_conntrack_tcp_timeout_established = 600
              EOF

              echo "Config file saved to /etc/sysctl.d/99-network-tuning.conf"
          securityContext:
            privileged: true
          volumeMounts:
            - name: host-sysctl
              mountPath: /host-sysctl
      containers:
        - name: pause
          image: gcr.io/google_containers/pause:3.2
          resources:
            requests:
              cpu: 10m
              memory: 10Mi
            limits:
              cpu: 10m
              memory: 10Mi
      volumes:
        - name: host-sysctl
          hostPath:
            path: /etc/sysctl.d
            type: DirectoryOrCreate
